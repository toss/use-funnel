import { Tabs, Callout } from 'nextra/components'
import { UseFunnelCodeBlock, Keyword } from '@/components'

# <Keyword keyword="step" /> 별 <Keyword keyword="context" /> 정의하기

`@use-funnel` 에서는 <Keyword keyword="step" /> 에서 필요한 <Keyword keyword="context" /> 들의 타입을 지정해야해요. 이 문서를 통해 다양한 방법으로 <Keyword keyword="step" /> 별 <Keyword keyword="context" /> 를 정의하는 방법을 알아볼게요.

## 제네릭으로 정의하기

<UseFunnelCodeBlock>
```tsx /funnel/
import { useFunnel } from "@use-funnel/next";

// 1. 아무것도 입력 안됨
type 이메일입력 = { email?: string; password?: string; other?: unknown }
// 2. 이메일은 입력됨
type 비밀번호입력 = { email: string; password?: string; other?: unknown }
// 3. 이메일과 비밀번호 입력됨
type 그외정보입력 = { email: string; password: string; other?: unknown }

function MyFunnelApp() {
  const funnel = useFunnel<{
    이메일입력: 이메일입력;
    비밀번호입력: 비밀번호입력;
    그외정보입력: 그외정보입력;
  }>({
    id: "how-to-define-step-contexts",
    initial: {
      step: "이메일입력",
      context: {}
    }
  });

  funnel.step === '이메일입력' && typeof funnel.context.email // "string" | "undefined"
  funnel.step === '비밀번호입력' && typeof funnel.context.email // "string"

  funnel.step === '비밀번호입력' && typeof funnel.context.password // "string" | "undefined"
  funnel.step === '그외정보입력' && typeof funnel.context.password // "string"
  // ...
}
```
</UseFunnelCodeBlock>

각 <Keyword keyword="step" /> 별로 필요한 <Keyword keyword="context" /> 의 타입을 제네릭으로 정의하고, <Keyword keyword="step" /> 을 키로, <Keyword keyword="context" /> 의 타입을 값으로 하는 객체 타입을 `useFunnel()` 의 제네릭으로 넘겨주세요.

## steps 객체 정의하기

```tsx
interface FunnelStepOption<TContext> {
  guard?: (data: unknown) => data is TContext;
  parse?: (data: unknown) => TContext;
}
```


`useFunnel()` 의 `steps` 옵션을 통해 <Keyword keyword="step" /> 을 정의하고, `guard()` 혹은 `parse()` 를 통해 <Keyword keyword="context" /> 를 정의할 수 있어요.

<UseFunnelCodeBlock>
```tsx /steps/
import { useFunnel } from "@use-funnel/next";

type FormState = {
  email?: string;
  password?: string;
  other?: unknown;
}

function 이메일입력_guard (data: unknown): data is FormState {
  return true;
}

function 비밀번호입력_parse (data: unknown): FormState & { password: string } {
  if (!(data != null && typeof data === 'object' && 'password' in data)) {
    throw new Error('비밀번호입력 데이터가 아닙니다.');
  }
  return data;
}

function 그외정보입력_guard (data: unknown): data is FormState & { password: string; other: unknown } {
  return 비밀번호입력_guard(data) && 'other' in data;
}

function MyFunnelApp() {
  const funnel = useFunnel({
    id: "step-by-step",
    steps: {
      이메일입력: { guard: 이메일입력_guard },
      비밀번호입력: { parse: 비밀번호입력_parse },
      그외정보입력: { guard: 그외정보입력_guard },
    },
    initial: {
      step: "이메일입력",
      context: {}
    }
  })

  funnel.step === '이메일입력' && typeof funnel.context.email // "string" | "undefined"
  funnel.step === '비밀번호입력' && typeof funnel.context.email // "string"

  funnel.step === '비밀번호입력' && typeof funnel.context.password // "string" | "undefined"
  funnel.step === '그외정보입력' && typeof funnel.context.password // "string"
  // ...
}
```
</UseFunnelCodeBlock>

- `guard()` 를 사용하면 해당 <Keyword keyword="step" /> 으로 진입 했을 때 <Keyword keyword="context" /> 가 유효하지 않을 경우, `initial` 에서 정의한 <Keyword keyword="step" /> 과 <Keyword keyword="context" /> 로 대체해요.
- `parse()` 를 사용하면 해당 <Keyword keyword="step" /> 으로 진입 했을 때 <Keyword keyword="context" /> 가 유효하지 않을 경우, 에러를 발생시켜요.

<Callout>
두 개 모두 정의되어 있을 경우 `guard()` 가 먼저 실행돼요.
</Callout>

### `createFunnelSteps()` 사용하기

```tsx /steps/
declare function createFunnelSteps<FormState>(): {
  extends: (name: string | string[], options?: { requiredKeys: string | string[] }) => this;
  build: () => Record<string, FunnelStepOption>;
}
```

간단하게 다음 <Keyword keyword="step" /> 으로 넘어갈 때 초기 <Keyword keyword="context" /> 의 특정 키가 optional에서 required로 변경되어 진행되는 <Keyword keyword="step" /> 을 만들 수 있어요.

<UseFunnelCodeBlock>
```tsx /funnel/
import { createFunnelSteps, useFunnel } from "@use-funnel/next";

type FormState = {
  email?: string;
  password?: string;
  other?: unknown;
}

const steps = createFunnelSteps<FormState>()
   .extends('이메일입력')
   .extends('비밀번호입력', { requiredKeys: 'email' })
   .extends('그외정보입력', { requiredKeys: 'password' })
   .build();

function MyFunnelApp() {
  const funnel = useFunnel({
    id: "create-funnel-steps",
    steps: steps,
    initial: {
      step: "이메일입력",
      context: {}
    }
  });

  funnel.step === '이메일입력' && typeof funnel.context.email // "string" | "undefined"
  funnel.step === '비밀번호입력' && typeof funnel.context.email // "string"

  funnel.step === '비밀번호입력' && typeof funnel.context.password // "string" | "undefined"
  funnel.step === '그외정보입력' && typeof funnel.context.password // "string"
  // ...
}
```
</UseFunnelCodeBlock>


## Runtime validator package 사용하기

런타임 밸리데이터에서 제공하는 parse와 guard 함수를 사용하는 방법도 있어요. 여기서는 `zod` 와 `superstruct` 를 사용한 예제를 보여드릴게요.

<Tabs items={['zod', 'superstruct']}>
<Tabs.Tab>
```tsx /funnel/
import { z } from 'zod';

const 이메일입력_Schema = z.object({
  email: z.string(),
  password: z.string(),
  other: z.unknown()
}).partial();

const 비밀번호입력_Schema = 이메일입력_Schema.required({ email: true });
const 그외정보입력_Schema = 비밀번호입력_Schema.required({ password: true });

function MyFunnelApp() {
  const funnel = useFunnel({
    id: "zod-example",
    steps: {
      이메일입력: { parse: 이메일입력_Schema.parse },
      비밀번호입력: { parse: 비밀번호입력_Schema.parse },
      그외정보입력: { parse: 그외정보입력_Schema.parse },
    },
    initial: {
      step: "이메일입력",
      context: {}
    }
  });

  funnel.step === '이메일입력' && typeof funnel.context.email // "string" | "undefined"
  funnel.step === '비밀번호입력' && typeof funnel.context.email // "string"

  funnel.step === '비밀번호입력' && typeof funnel.context.password // "string" | "undefined"
  funnel.step === '그외정보입력' && typeof funnel.context.password // "string"
  // ...
}
```
</Tabs.Tab>
<Tabs.Tab>
```tsx /funnel/
import { partial, object, string, unknown, assign, omit, pick, create } from 'superstruct';

const schema = object({
  email: string(),
  password: string(),
  other: unknown()
})

const 이메일입력_Schema = partial(
  schema
);

const 비밀번호입력_Schema = assign(
  omit(이메일입력_Schema, ['email']),
  pick(schema, ['email'])
);

const 그외정보입력_Schema = assign(
  omit(비밀번호입력_Schema, ['password']),
  pick(schema, ['password'])
);

function MyFunnelApp() {
  const funnel = useFunnel({
    id: "superstruct-example",
    steps: {
      이메일입력: { parse: (data) => create(data, 이메일입력_Schema) },
      비밀번호입력: { parse: (data) => create(data, 비밀번호입력_Schema) },
      그외정보입력: { parse: (data) => create(data, 그외정보입력_Schema) },
    },
    initial: {
      step: "이메일입력",
      context: {}
    }
  });

  funnel.step === '이메일입력' && typeof funnel.context.email // "string" | "undefined"
  funnel.step === '비밀번호입력' && typeof funnel.context.email // "string"

  funnel.step === '비밀번호입력' && typeof funnel.context.password // "string" | "undefined"
  funnel.step === '그외정보입력' && typeof funnel.context.password // "string"
  // ...
}
```
</Tabs.Tab>
</Tabs>

