# 직접 router 만드는 방법

`@use-funnel`은 안정적인 뒤로가기 앞으로 가기를 위해 각 퍼널 단계에 대한 상태 스냅샷을 배열로 저장해요.
라우터 패키지에서 기본적으로 제공하는 기능을 사용하지 않고 직접 만들어보는 방법을 알아볼게요.

```shell npm2yarn
npm install @use-funnel/core --save
```

먼저 `@use-funnel/core` 패키지를 설치해요.

```tsx filename="src/hooks/useFunnel.ts"
import { useMemo, useState } from 'react';
import { createUseFunnel } from '@use-funnel/core';

export const useFunnel = createUseFunnel(({ id, initialState }) => {
  const [history, setHistory] = useState(() => [initialState]);
  const [currentIndex, setCurrentIndex] = useState(0);

  return useMemo(
    () => ({
      history,
      currentIndex,
      push(state) {
        setHistory((prev) => {
          const next = prev.slice(0, currentIndex + 1);
          return [...next, state];
        });
        setCurrentIndex((prev) => prev + 1);
      },
      replace(state) {
        setHistory((prev) => {
          const next = prev.slice(0, currentIndex);
          return [...next, state];
        });
      },
      go(delta) {
        setCurrentIndex((prev) => prev + delta);
      },
    }),
    [history, currentIndex],
  );
});
```

위 예제는 라우터 없이 `useState` 만으로 퍼널을 구현한 예제에요. `createUseFunnel()` 의 인자로는 다음과 같은 객체(`CreateUseFunnelOptions<T>`)를 넘겨줘요.

```ts
interface CreateUseFunnelOptions<T> {
  /**
   * 퍼널의 고유한 식별자. 이걸로 한 페이지에 여러 퍼널이 있을 때 전역 상태를 구분해요.
   */
  id: string;
  /**
   * `useFunnel()` 에서 `initial` 로 넘겨준 퍼널의 초기 상태. 퍼널 진입 시 이 상태로 시작해요.
   */
  initialState: FunnelState<T>;
}

/**
 * 퍼널의 상태. `step` 은 퍼널의 단계명을 나타내고, `context` 는 해당 단계에서 필요한 상태를 나타내어요.
 */
interface FunnelState<T> {
  step: string;
  context: T;
}
```

다음과 같은 인터페이스(`CreateUseFunnelResult<T>`)를 구현해야해요. `createUseFunnel()` 의 내부적으로 `useMemo` 를 사용해 최적화를 해야해요.

```ts
interface CreateUseFunnelResult<T> {
  /**
   * 퍼널의 상태 스냅샷 배열. 퍼널 진입 후 쌓인 라우팅 내역을 가진 배열.
   */
  history: FunnelState<T>[];
  /**
   * 현재 진행중인 퍼널 단계의 index.
   */
  currentIndex: number;
  /**
   * 현재 `history` 에서 새로운 `history` 를 추가하며 다음 퍼널로 이동하는 동작 구현.
   */
  push(state: FunnelState<T>): void | Promise<void>;
  /**
   * 현재 `history` 를 덮어쓰고 다음 퍼널로 이동하는 경우 동작 구현.
   */
  replace(state: FunnelState<T>): void | Promise<void>;
  /**
   * `history` 배열에서 `delta` 만큼 이동하는 동작 구현.
   */
  go(delta: number): void | Promise<void>;
}
```
